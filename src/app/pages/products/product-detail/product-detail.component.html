<section *ngIf="(isLoading$ | async)" class="page-loading" test-id="product-loader">
    <div>
        <ngx-skeleton-loader appearance="line" count="1"
            [theme]="{height: '32px', width: '123px', 'margin-bottom': '16px'}">
        </ngx-skeleton-loader>
    </div>
    <div>
        <ngx-skeleton-loader appearance="line" count="1"
            [theme]="{height: '56px', width: '100%', 'margin-bottom': 0}">
        </ngx-skeleton-loader>
        <ngx-skeleton-loader appearance="line" count="3"
            [theme]="{height: '48px', width: '100%', 'margin-bottom': 0}">
        </ngx-skeleton-loader>
    </div>
</section>

<section *ngIf="!(isLoading$ | async)" class="page" test-id="product">
    <h1>Detalhes do produto</h1>
    <form [formGroup]="form" *ngIf="form">
        <div>
            <mat-form-field>
                <mat-label>Nome</mat-label>
                <input matInput placeholder="Nome" formControlName="name">
                <mat-error *ngIf="form.get('name')?.hasError('required')">
                    Nome é obrigatório
                </mat-error>
            </mat-form-field>
        </div>
        <div>
            <mat-form-field>
                <mat-label>Categoria</mat-label>
                <mat-select formControlName="categoryId">
                    <mat-option *ngFor="let category of categories$ | async" [value]="category.id">
                        {{category.name}}
                    </mat-option>
                </mat-select>
                <mat-error *ngIf="form.get('category')?.hasError('required')">
                    Categoria é obrigatória
                </mat-error>
            </mat-form-field>
        </div>
        <div>
            <mat-form-field>
                <mat-label>Preço</mat-label>
                <input matInput type="number" placeholder="Preço" formControlName="price">
                <mat-error *ngIf="form.get('name')?.hasError('required')">
                    Preço é obrigatório
                </mat-error>
            </mat-form-field>
            <mat-form-field>
                <mat-label>Preço com desconto</mat-label>
                <input matInput type="number" placeholder="Preço com desconto"
                    formControlName="priceWithDiscount">
                <mat-error *ngIf="form.get('priceWithDiscount')?.hasError('required')">
                    Preço com desconto é obrigatório
                </mat-error>
            </mat-form-field>
        </div>

        <button type="button" mat-raised-button color="primary" (click)="save()"
            [disabled]="!form.valid" *ngIf="!(isSaving$ | async)" test-id="save-button">
            Salvar
        </button>
        <button type="button" mat-button *ngIf="isSaving$ | async">
            <mat-spinner color="primary" diameter="20" test-id="save-loader"></mat-spinner>
        </button>
    </form>

    <section *ngIf="(product$ | async)" test-id="stock">
        <mat-divider></mat-divider>
        <h2>Estoque</h2>

        <div *ngIf="(isLoadingStock$ | async)" test-id="stock-loader">
            <ngx-skeleton-loader appearance="line" count="1"
                [theme]="{height: '200px', width: '100%'}">
            </ngx-skeleton-loader>
        </div>
        
        <div align="right">
            <button type="button" mat-button color="primary" (click)="showAddToStock()"
                test-id="add-stock-button">
                Adicionar ao estoque
            </button>
        </div>
        <table mat-table [dataSource]="dataSource" *ngIf="!(isLoadingStock$ | async)"
            test-id="stock-details">
            <ng-container matColumnDef="amount">
                <th mat-header-cell *matHeaderCellDef>Quantidade</th>
                <td mat-cell *matCellDef="let element">{{element.quantity}}</td>
            </ng-container>
            <ng-container matColumnDef="color">
                <th mat-header-cell *matHeaderCellDef>Cor</th>
                <td mat-cell *matCellDef="let element">
                    <div class="centralize">
                        <div class="color" [ngStyle]="{'background-color': element.color}"></div>
                        {{element.color}}
                    </div>
                </td>
            </ng-container>
            <ng-container matColumnDef="size">
                <th mat-header-cell *matHeaderCellDef>Tamanho</th>
                <td mat-cell *matCellDef="let element">{{element.size}}</td>
            </ng-container>
            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
        <div *ngIf="(stock$ | async)?.length === 0" align="middle" test-id="no-results-found">
            Nenhum resultado encontrado
        </div>
    </section>
</section>